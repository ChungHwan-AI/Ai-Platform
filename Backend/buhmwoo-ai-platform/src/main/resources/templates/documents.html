<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>문서 관리 콘솔</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- ✅ ChatGPT 레이아웃과 유사한 상·하단 2분할 구조를 구성하기 위한 전체 스타일을 정의합니다. -->
    <style>
    /* ✅ 화면 전체 배경과 폰트를 설정하여 집중형 콘솔 느낌을 만듭니다. */
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f4f7fb 0%, #eef1f8 40%, #f9fafc 100%);
            font-family: "Pretendard", "Noto Sans KR", sans-serif;
            color: #0f172a;
        }

        /* ✅ 중앙 정렬된 고정 폭 레이아웃을 위해 래퍼에 여백을 부여합니다. */
        .chat-wrapper {
            width: min(1100px, 100%);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            padding: 2.5rem 1.5rem 7.5rem; /* ✅ 하단 고정 바 공간을 확보하기 위해 패딩을 크게 줍니다. */
            box-sizing: border-box;
        }

        /* ✅ 상단 헤더 카드를 유리 느낌으로 표현해 현재 상태를 강조합니다. */
        .chat-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            border: 1px solid rgba(226, 232, 240, 0.7);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
            padding: 2.5rem 2.25rem;
            margin-bottom: 2rem;
        }

        /* ✅ 헤더 안에서 제목과 통계 정보를 나란히 배치합니다. */
        .chat-header-top {
            display: flex;
            flex-wrap: wrap;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        /* ✅ 통계 뱃지 스타일을 정의합니다. */
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(14, 165, 233, 0.18));
            color: #0f172a;
            font-weight: 600;
        }

        /* ✅ 메인 영역은 ChatGPT 메시지 흐름과 유사하게 스택으로 쌓이도록 구성합니다. */
        .chat-feed {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* ✅ 메시지 카드 공통 스타일을 정의합니다. */
        .chat-bubble {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 1.25rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
            padding: 1.75rem;
        }


        /* ✅ 하단 고정 입력 영역을 구성합니다. */
        .chat-footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(248, 250, 252, 0.92);
            border-top: 1px solid rgba(203, 213, 225, 0.7);
            backdrop-filter: blur(14px);
            padding: 1.25rem 1rem;
            display: flex; /* ✅ 질문 입력과 버튼 묶음을 세로로 쌓아 배치합니다. */
            justify-content: center; /* ✅ 중앙 정렬을 유지해 안정적인 구성을 만듭니다. */
        }

        /* ✅ 하단 고정 영역 내부 너비와 간격을 제어하는 컨테이너입니다. */
        .footer-inner {
            width: min(900px, 100%);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 0 auto;
        }

        /* ✅ 질문 입력 박스 전반의 배경과 여백을 정의합니다. */
        .question-box {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(203, 213, 225, 0.6);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        /* ✅ 질문 폼을 반응형으로 가로·세로 배치할 수 있도록 구성합니다. */
        .question-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* ✅ 질문 입력창의 높이와 테두리를 조정해 일관된 스타일을 유지합니다. */
        .question-form textarea {
            min-height: 100px;
            border-radius: 0.85rem;
            border: 1px solid rgba(148, 163, 184, 0.6);
            resize: vertical;
        }

        /* ✅ 질문 대상 안내 문구를 강조하기 위한 스타일입니다. */
        .question-target {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #1f2937;            
        }

        /* ✅ 하단 버튼 바의 중앙 정렬과 버튼 간격을 조정합니다. */
        .action-bar {
            width: min(900px, 100%);
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        /* ✅ 플러스 버튼에 원형 스타일을 부여해 업로드 동작을 직관화합니다. */
        .btn-plus {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 999px;
            padding: 0.85rem 1.35rem;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
        }

        /* ✅ 보조 버튼을 유리 느낌으로 표현합니다. */
        .btn-glass {
            border-radius: 999px;
            padding: 0.85rem 1.35rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: rgba(255, 255, 255, 0.75);
            color: #1f2937;
            font-weight: 600;
        }

        /* ✅ 검색 결과 행을 선택했을 때 시각적으로 표시해 주는 스타일입니다. */
        .document-row-active {
            outline: 2px solid rgba(37, 99, 235, 0.65);
            outline-offset: -2px;
            background: rgba(59, 130, 246, 0.08);
        }

        /* ✅ 상세 정보 패널의 레이아웃과 배경을 정의합니다. */
        .detail-panel {
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 1rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        /* ✅ 모달 내부의 카드 스타일을 통일합니다. */
        .modal-card {
            background: rgba(248, 250, 252, 0.88);
            border-radius: 1.25rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        /* ✅ 긴 표 영역의 스크롤을 보장합니다. */
        .table-scroll {
            max-height: 420px;
            overflow-y: auto;
        }

        /* ✅ 반응형 환경에서 패딩과 배치를 조정합니다. */
        @media (max-width: 768px) {
            .chat-wrapper {
                padding: 1.75rem 1rem 8.5rem;
            }

            .chat-header {
                padding: 1.75rem 1.5rem;
            }

            .chat-bubble {
                padding: 1.35rem;
            }
            .question-form {
                flex-direction: column;
            }            
        }
    </style>
</head>
<body>
<div id="documentPageState" class="d-none" th:data-open-search-modal="${searchTriggered}"></div> <!-- ✅ 검색 이후에도 모달을 유지하기 위해 현재 화면 상태를 data-* 속성으로 전달합니다. -->    
<div class="chat-wrapper">
    <!-- ✅ 상단 헤더: 현재 문서 상태와 간단한 설명을 제공합니다. -->
    <header class="chat-header">
        <div class="chat-header-top">
            <div>
                <h1 class="fw-bold mb-3">문서 관리 콘솔</h1>
                <p class="mb-2 text-muted">ChatGPT 스타일 콘솔에서 문서를 업로드하고 검색하며 질문할 수 있습니다.</p>
                <p class="mb-0 text-muted">모든 주요 동작은 하단 버튼을 통해 실행됩니다.</p>
            </div>
            <span class="stat-badge">
                <span class="fw-semibold">전체 문서</span>
                <span class="fs-4" th:text="${#numbers.formatInteger(page.totalElements, 1, 'COMMA')}">0</span>
            </span>
        </div>
    </header>

    <main class="chat-feed">
        <!-- ✅ 알림 메시지가 존재하면 채팅 버블로 출력합니다. -->
        <section th:if="${alertMessage}" class="chat-bubble">
            <div th:class="${'alert alert-' + (alertType ?: 'info')} mb-0" role="alert" th:text="${alertMessage}"></div>
        </section>    

        <!-- ✅ 업로드 결과가 있을 경우 상세 정보를 제공하는 버블을 추가합니다. -->
        <section th:if="${uploadResult}" class="chat-bubble">
            <h2 class="h5 fw-bold mb-3">업로드 완료</h2>
            <dl class="row mb-0">
                <dt class="col-sm-3">UUID</dt>
                <dd class="col-sm-9" th:text="${uploadResult.uuid}"></dd>
                <dt class="col-sm-3">파일명</dt>
                <dd class="col-sm-9" th:text="${uploadResult.fileName}"></dd>
                <dt class="col-sm-3">미리보기</dt>
                <dd class="col-sm-9"><pre th:text="${uploadResult.previewText}"></pre></dd>
            </dl>
        </section>
        <!-- ✅ 질의 결과가 존재하면 대화 응답처럼 노출합니다. -->
        <section th:if="${askResult}" class="chat-bubble">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                <h2 class="h5 fw-bold mb-0">질의 응답</h2>
                <span class="badge text-bg-info" th:text="${askTarget == 'ALL' ? '전체 문서' : '문서 UUID: ' + askTarget}"></span>
             </div>
            <pre class="mb-0" th:text="${askResult}"></pre>
        </section>
        <!-- ✅ 최근 업로드 문서를 요약해 보여주는 버블입니다. -->
        <section class="chat-bubble">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                <div>
                    <h2 class="h5 fw-bold mb-1">최근 문서 하이라이트</h2>
                    <small class="text-muted">상세 목록과 검색은 하단 버튼을 통해 확인할 수 있습니다.</small>
                 </div>
                <span class="badge text-bg-light" th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm')}"
                      >--:--</span>
             </div>
            <div th:if="${#lists.isEmpty(documents)}" class="text-muted">현재 등록된 문서가 없습니다. 하단의 [+ 업로드] 버튼을 눌러 문서를 추가하세요.</div>
            <ul class="list-unstyled mb-0" th:if="${!#lists.isEmpty(documents)}">
                <li class="mb-3" th:each="doc,iterStat : ${documents}" th:if="${iterStat.index < 3}">
                    <div class="fw-semibold" th:text="${doc.fileName}"></div>
                    <div class="small text-muted" th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></div>
                    <div class="small text-muted" th:text="${doc.description}"></div>
                </li>
                <li th:if="${documents.size() > 3}" class="text-muted small">그 외 <span th:text="${documents.size() - 3}"></span>건의 문서가 있습니다. 하단 버튼으로 전체 목록을 확인하세요.</li>
            </ul>
        </section>
    </main>
</div>
<!-- ✅ 문서 업로드를 위한 모달 영역을 정의합니다. -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-card">
            <div class="modal-header border-0">
                <h1 class="modal-title fs-5" id="uploadModalLabel">문서 업로드</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <!-- ✅ 문서 업로드 폼을 제공하여 선택한 파일과 설명을 전송합니다. -->
                <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">파일</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">설명</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="파일 설명을 입력하세요">
                    </div>
                    <div class="mb-4">
                        <label for="uploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="uploadedBy" name="uploadedBy" value="system">
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">업로드</button>
                    </div>
                </form>
             </div>
         </div>
    </div>
</div>
<!-- ✅ 문서 검색과 목록 확인을 위한 모달입니다. -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-md-down modal-xl">
        <div class="modal-content modal-card">
            <div class="modal-header border-0">
                <h1 class="modal-title fs-5" id="searchModalLabel">문서 검색 및 목록</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
             </div>
            <div class="modal-body">
                <!-- ✅ 검색 폼을 통해 조건을 입력하고 페이지 전체를 갱신합니다. -->
                <form class="row g-3 mb-4" method="get" th:action="@{/documents}">
                    <div class="col-md-3">
                        <label for="searchFileName" class="form-label">파일명</label>
                        <input type="text" class="form-control" id="searchFileName" name="fileName" th:value="${searchParams.fileName}">
                     </div>
                    <div class="col-md-3">
                        <label for="searchUploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="searchUploadedBy" name="uploadedBy" th:value="${searchParams.uploadedBy}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchFrom" class="form-label">업로드 시작일</label>
                        <input type="date" class="form-control" id="searchFrom" name="uploadedFrom" th:value="${searchParams.uploadedFrom}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchTo" class="form-label">업로드 종료일</label>
                        <input type="date" class="form-control" id="searchTo" name="uploadedTo" th:value="${searchParams.uploadedTo}">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-secondary">검색</button>
                        <a class="btn btn-outline-secondary" th:href="@{/documents}">초기화</a>
                    </div>
                </form>

                <!-- ✅ 전체 문서 목록을 표 형태로 보여주며 스크롤을 지원합니다. -->
                <div class="table-scroll mb-3">
                    <table class="table align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>UUID</th>
                            <th>파일명</th>
                            <th>업로더</th>
                            <th>업로드 일시</th>
                            <th class="text-end">크기(bytes)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(documents)}">
                            <td colspan="5" class="text-center text-muted">조회된 문서가 없습니다.</td>
                        </tr>
                        <tr th:each="doc : ${documents}"
                            th:attr="data-document-row=${doc.uuid}, data-document-name=${doc.fileName}, data-document-description=${doc.description}, data-document-uploaded-by=${doc.uploadedBy}, data-document-uploaded-at=${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}, data-document-size=${#numbers.formatInteger(doc.size, 1, 'COMMA')}"
                            class="cursor-pointer">
                            <td class="small text-break" th:text="${doc.uuid}"></td>
                            <td>
                                <div class="fw-semibold" th:text="${doc.fileName}"></div>
                                <div class="text-muted small" th:text="${doc.description}"></div>
                            </td>
                            <td th:text="${doc.uploadedBy}"></td>
                            <td th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td class="text-end" th:text="${#numbers.formatInteger(doc.size, 1, 'COMMA')}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!-- ✅ 선택한 문서의 상세 정보를 보여줄 패널을 제공합니다. -->
                <div class="detail-panel mt-4" id="documentDetailPanel"
                     th:attr="data-download-base=@{/api/documents/download/}, data-delete-base=@{/documents/}">
                    <h3 class="h6 fw-bold mb-3">선택한 문서 상세</h3>
                    <p class="text-muted mb-0" id="documentDetailPlaceholder">검색된 문서를 클릭하면 상세 정보와 사용 가능한 작업이 여기에 나타납니다.</p>
                    <div id="documentDetailContent" class="d-none">
                        <dl class="row mb-3">
                            <dt class="col-sm-3">파일명</dt>
                            <dd class="col-sm-9" id="detailFileName"></dd>
                            <dt class="col-sm-3">UUID</dt>
                            <dd class="col-sm-9" id="detailUuid"></dd>
                            <dt class="col-sm-3">업로더</dt>
                            <dd class="col-sm-9" id="detailUploadedBy"></dd>
                            <dt class="col-sm-3">업로드 일시</dt>
                            <dd class="col-sm-9" id="detailUploadedAt"></dd>
                            <dt class="col-sm-3">설명</dt>
                            <dd class="col-sm-9" id="detailDescription"></dd>
                            <dt class="col-sm-3">크기</dt>
                            <dd class="col-sm-9" id="detailSize"></dd>
                        </dl>
                        <div class="d-flex flex-wrap gap-2">
                            <a id="documentDownloadLink" class="btn btn-sm btn-outline-secondary disabled" href="#" target="_blank" aria-disabled="true">다운로드</a>
                            <form id="documentDeleteForm" method="post" class="d-flex d-none"
                                  onsubmit="return confirm('문서를 삭제하시겠습니까?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                            </form>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            <button type="button" class="btn btn-sm btn-primary" id="applySelectedDocument" disabled>선택 문서 적용</button> <!-- ✅ 사용자가 특정 문서를 선택한 뒤 메인 질문 영역에 즉시 반영하도록 확정하는 버튼입니다. -->
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="applyAllDocuments">전체 문서 질문</button> <!-- ✅ 선택을 취소하고 전체 문서를 대상으로 다시 질문할 수 있게 돕는 버튼입니다. -->
                        </div>
                        <div class="alert alert-info small mt-3 mb-0" id="documentSelectionHint">선택된 문서는 [선택 문서 적용] 버튼을 누르거나 창을 닫으면 하단 질문 영역에 대상 문서로 반영됩니다.

                        </div> <!-- ✅ 선택 적용 방법을 명시해 사용자가 흐름을 이해할 수 있도록 안내 문구를 갱신합니다. -->
                    </div>
                </div>
                <!-- ✅ 페이지 네비게이션을 모달 하단에 유지합니다. -->
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                    <div class="text-muted">
                        <span th:text="${page.page + 1}"></span>
                        /
                        <span th:text="${page.totalPages == 0 ? 1 : page.totalPages}"></span>
                        페이지
                     </div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item" th:classappend="${page.first} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page - 1}, size=${page.size}, fileName=${searchParams.fileName}, uploadedBy=${searchParams.uploadedBy}, uploadedFrom=${searchParams.uploadedFrom}, uploadedTo=${searchParams.uploadedTo})}">이전</a>
                            </li>
                            <li class="page-item" th:each="pageNumber : ${pageNumbers}" th:classappend="${pageNumber == page.page} ? ' active'">
                                <a class="page-link" th:text="${pageNumber + 1}"
                                   th:href="@{/documents(page=${pageNumber}, size=${page.size}, fileName=${searchParams.fileName}, uploadedBy=${searchParams.uploadedBy}, uploadedFrom=${searchParams.uploadedFrom}, uploadedTo=${searchParams.uploadedTo})}"></a>
                            </li>
                            <li class="page-item" th:classappend="${page.last} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page + 1}, size=${page.size}, fileName=${searchParams.fileName}, uploadedBy=${searchParams.uploadedBy}, uploadedFrom=${searchParams.uploadedFrom}, uploadedTo=${searchParams.uploadedTo})}">다음</a>
                            </li>
                        </ul>
                    </nav>
                 </div>
             </div>
         </div>
     </div>
 </div> 
<!-- ✅ 하단 고정 버튼 바: 모든 주요 액션을 여기서 실행합니다. -->
<footer class="chat-footer">
    <div class="footer-inner">
        <!-- ✅ 질문 입력과 대상 안내를 묶은 하단 상자를 제공합니다. -->
        <div class="question-box">
            <form id="mainQuestionForm" class="question-form"
                  th:attr="data-ask-all=@{/documents/ask}, data-ask-base=@{/documents/}, data-initial-target=${askTarget != null ? askTarget : 'ALL'}"
                  method="post">
                <div class="question-target">
                    <span id="questionTargetLabel"
                          th:text="${askTarget == null or askTarget == 'ALL' ? '전체 문서를 대상으로 질문합니다.' : '선택된 문서(UUID): ' + askTarget}">전체 문서를 대상으로 질문합니다.</span>
                    <!-- ✅ 선택된 문서를 초기화해 전체 범위로 전환하는 버튼입니다. -->
                    <button type="button" class="btn btn-sm btn-outline-secondary d-none" id="resetQuestionTarget">전체 문서로 전환</button>
                </div>
                <div class="d-flex flex-column flex-md-row gap-2">
                    <!-- ✅ 사용자가 질문을 입력하는 본문 영역입니다. -->
                    <textarea class="form-control" id="mainQuestionInput" name="question"
                              placeholder="질문을 입력하세요" required></textarea>
                    <div class="d-flex flex-md-column gap-2">
                        <!-- ✅ 질문을 전송하는 메인 실행 버튼입니다. -->
                        <button type="submit" class="btn btn-primary flex-fill">질문하기</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="action-bar">
            <button class="btn btn-plus" data-bs-toggle="modal" data-bs-target="#uploadModal">＋ 업로드</button>
            <button class="btn btn-glass" data-bs-toggle="modal" data-bs-target="#searchModal">문서 검색 / 목록</button>
        </div>
    </div>
</footer>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // ✅ 문서 선택과 질문 전송 흐름을 제어하는 초기화 스크립트입니다.        
        document.addEventListener('DOMContentLoaded', function () {
            var questionForm = document.getElementById('mainQuestionForm'); // ✅ 하단 질문 입력 폼을 찾아 선택된 문서 정보를 연동합니다.
            if (!questionForm) {
                return; // ✅ 폼이 없으면 초기화 로직이 필요하지 않으므로 조기에 종료합니다.
            }

            var searchModalElement = document.getElementById('searchModal'); // ✅ 검색 모달 요소를 찾아 이후 자동 열기 및 닫기 동작에 활용합니다.
            var searchModalInstance = null; // ✅ 부트스트랩 모달 인스턴스를 저장해 재사용합니다.
            if (searchModalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                searchModalInstance = bootstrap.Modal.getOrCreateInstance(searchModalElement); // ✅ 부트스트랩 유틸리티를 사용해 모달 인스턴스를 준비합니다.
            }
            var pageState = document.getElementById('documentPageState'); // ✅ 서버에서 전달한 모달 오픈 여부를 확인하기 위한 요소를 조회합니다.
            var shouldAutoOpenModal = pageState && pageState.dataset.openSearchModal === 'true'; // ✅ 자동으로 모달을 열어야 하는지 여부를 미리 계산합니다.
            if (shouldAutoOpenModal && searchModalElement) {
                searchModalElement.addEventListener('shown.bs.modal', function () {
                    var searchField = document.getElementById('searchFileName');
                    if (searchField) {
                        searchField.focus(); // ✅ 모달이 다시 열리면 곧바로 검색 입력에 포커스를 맞춰 재검색이 편하도록 합니다.
                    }
                });
            }
            if (shouldAutoOpenModal && searchModalInstance) {
                searchModalInstance.show(); // ✅ 검색이나 페이지 이동 이후에는 화면 로딩 시 모달을 자동으로 다시 표시합니다.
            }

            var askAllUrl = questionForm.dataset.askAll || ''; // ✅ 전체 문서 질의 엔드포인트 경로를 data-* 속성에서 읽어옵니다.
            var askBase = questionForm.dataset.askBase || ''; // ✅ 특정 문서를 대상으로 질문할 때 사용할 기본 경로를 준비합니다.
            if (askBase && !askBase.endsWith('/')) {
                askBase += '/'; // ✅ URL 결합 시 슬래시 누락으로 인한 404를 방지하기 위해 후행 슬래시를 보정합니다.
            }

            var targetLabel = document.getElementById('questionTargetLabel');
            var resetButton = document.getElementById('resetQuestionTarget');
            var detailPanel = document.getElementById('documentDetailPanel');
            var detailContent = document.getElementById('documentDetailContent');
            var detailPlaceholder = document.getElementById('documentDetailPlaceholder');
            var detailFileName = document.getElementById('detailFileName');
            var detailUuid = document.getElementById('detailUuid');
            var detailUploadedBy = document.getElementById('detailUploadedBy');
            var detailUploadedAt = document.getElementById('detailUploadedAt');
            var detailDescription = document.getElementById('detailDescription');
            var detailSize = document.getElementById('detailSize');
            var downloadLink = document.getElementById('documentDownloadLink');
            var deleteForm = document.getElementById('documentDeleteForm');
            var confirmButton = document.getElementById('applySelectedDocument'); // ✅ 사용자가 선택한 문서를 확정할 버튼을 가져옵니다.
            var applyAllButton = document.getElementById('applyAllDocuments'); // ✅ 전체 문서 대상으로 전환하는 버튼을 가져옵니다.            
            var tableRows = Array.prototype.slice.call(document.querySelectorAll('tr[data-document-row]'));
            var downloadBase = detailPanel ? detailPanel.dataset.downloadBase : '';
            var deleteBase = detailPanel ? detailPanel.dataset.deleteBase : '';

            var selectedUuid = '';
            var selectedName = '';

            function setConfirmButtonState(isActive) { // ✅ 선택 상태에 따라 적용 버튼을 활성화하거나 비활성화하는 헬퍼입니다.
                if (!confirmButton) {
                    return;
                }
                if (isActive) {
                    confirmButton.removeAttribute('disabled');
                } else {
                    confirmButton.setAttribute('disabled', 'disabled');
                }
            }            
            // ✅ 질문 대상 상태를 갱신하는 헬퍼 함수입니다.
            function applyTarget(uuid, name) {
                selectedUuid = uuid || '';
                selectedName = name || '';
                questionForm.dataset.selectedUuid = selectedUuid;

                if (selectedUuid) {
                    if (targetLabel) {
                        targetLabel.textContent = '선택된 문서에 질문합니다: ' + (selectedName || ('UUID ' + selectedUuid));
                    }
                    if (resetButton) {
                        resetButton.classList.remove('d-none'); // ✅ 초기화 버튼을 눌렀을 때 전체 문서 모드로 되돌립니다.
                    }
                    setConfirmButtonState(true);
                } else {
                    if (targetLabel) {
                        targetLabel.textContent = '전체 문서를 대상으로 질문합니다.';
                    }
                    if (resetButton) {
                        resetButton.classList.add('d-none');
                    }
                    setConfirmButtonState(false);                    
                }
            }

            // ✅ 상세 패널을 업데이트하고 필요한 경우 질문 대상을 연결합니다.
            function renderDetail(row, shouldUpdateTarget) {
                if (!row || !detailPanel) {            
                    return;
                }
                tableRows.forEach(function (item) {
                    item.classList.remove('document-row-active');
                });
                row.classList.add('document-row-active');

                var uuid = row.dataset.documentRow || '';
                var name = row.dataset.documentName || '';
                var uploader = row.dataset.documentUploadedBy || '';
                var uploadedAt = row.dataset.documentUploadedAt || '';
                var description = row.dataset.documentDescription || '';
                var size = row.dataset.documentSize || '';

                if (detailPlaceholder && detailContent) {
                    detailPlaceholder.classList.add('d-none');
                    detailContent.classList.remove('d-none');
                }
                if (detailFileName) {
                    detailFileName.textContent = name || '-';
                }
                if (detailUuid) {
                    detailUuid.textContent = uuid || '-';
                }
                if (detailUploadedBy) {
                    detailUploadedBy.textContent = uploader || '-';
                }
                if (detailUploadedAt) {
                    detailUploadedAt.textContent = uploadedAt || '-';
                }
                if (detailDescription) {
                    detailDescription.textContent = description || '-';
                }
                if (detailSize) {
                    detailSize.textContent = size ? size + ' bytes' : '-';
                }

                if (downloadLink && downloadBase && uuid) {
                    downloadLink.href = downloadBase + uuid;
                    downloadLink.classList.remove('disabled');
                    downloadLink.setAttribute('aria-disabled', 'false');
                }

                if (deleteForm && deleteBase && uuid) {
                    deleteForm.action = deleteBase + uuid + '/delete';
                    deleteForm.classList.remove('d-none');
                }

                if (shouldUpdateTarget) {
                    applyTarget(uuid, name);
                } else if (uuid) {
                    setConfirmButtonState(true); // ✅ 기존 선택을 복원할 때도 버튼이 즉시 활성화되도록 보정합니다.                    
                }
            }

            // ✅ 각 행을 클릭했을 때 선택 로직이 실행되도록 이벤트를 연결합니다.
            tableRows.forEach(function (row) {
                row.addEventListener('click', function () {
                    renderDetail(row, true);
                });
            });

            // ✅ 초기 진입 시 기존 선택 정보를 반영하거나 기본 상태를 구성합니다.
            var initialTarget = questionForm.dataset.initialTarget;
            if (initialTarget && initialTarget !== 'ALL') {
                var matched = tableRows.find(function (row) {
                    return row.dataset.documentRow === initialTarget;
                });
                if (matched) {
                    renderDetail(matched, false);
                    applyTarget(initialTarget, matched.dataset.documentName || initialTarget);
                } else {
                    applyTarget(initialTarget, initialTarget);
                }
            } else {
                applyTarget('', '');
                if (tableRows.length === 1) {
                    renderDetail(tableRows[0], false);
                }
            }

                        function resetSelectionState() { // ✅ 선택 정보를 초기화하는 공통 루틴입니다.
                applyTarget('', '');
                tableRows.forEach(function (row) {
                    row.classList.remove('document-row-active');
                });
                if (detailPlaceholder && detailContent) {
                    detailContent.classList.add('d-none');
                    detailPlaceholder.classList.remove('d-none');
                }
                if (downloadLink) {
                    downloadLink.href = '#';
                    downloadLink.classList.add('disabled');
                    downloadLink.setAttribute('aria-disabled', 'true');
                }
                if (deleteForm) {
                    deleteForm.action = '';
                    deleteForm.classList.add('d-none');
                }
            }
            if (resetButton) {
                resetButton.addEventListener('click', function () {
                    resetSelectionState();
                });
            }

            if (applyAllButton) {
                applyAllButton.addEventListener('click', function () {
                    resetSelectionState(); // ✅ 모달 내부에서도 즉시 전체 문서 모드로 전환합니다.
                    if (searchModalInstance) {
                        searchModalInstance.hide();
                    }
                });
            }

            if (confirmButton) {
                confirmButton.addEventListener('click', function () {
                    if (!selectedUuid) {
                        alert('선택된 문서가 없습니다. 목록에서 문서를 선택해주세요.'); // ✅ 사용자가 선택 없이 버튼을 누르면 안내 메시지를 제공합니다.
                        return;
                    }
                    applyTarget(selectedUuid, selectedName); // ✅ 최신 선택 정보를 다시 한 번 확정해 하단 폼에 반영합니다.
                    if (searchModalInstance) {
                        searchModalInstance.hide(); // ✅ 확정 후 모달을 닫아 메인 화면으로 자연스럽게 전환합니다.
                    }
                });
            }

            // ✅ 폼 전송 시 선택 상태에 맞춰 요청 경로를 조정합니다.
            questionForm.addEventListener('submit', function () {
                if (selectedUuid) {
                    questionForm.action = (askBase || '/documents/') + selectedUuid + '/ask';
                } else {
                    questionForm.action = askAllUrl || '/documents/ask';
                }
            });
        });
            if (!shouldAutoOpenModal && searchModalElement) {
                searchModalElement.addEventListener('shown.bs.modal', function () {
                    var searchField = document.getElementById('searchFileName');
                    if (searchField) {
                        searchField.focus(); // ✅ 수동으로 모달을 열었을 때도 검색 필드를 자동 포커싱해 입력 편의성을 높입니다.
                    }
                });
            }        
    </script>
 </body>
 </html>
