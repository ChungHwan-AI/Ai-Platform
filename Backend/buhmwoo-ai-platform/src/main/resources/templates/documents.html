<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>문서 관리</title>
    <link rel="icon" type="image/png" href="/favicon.ico">    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { background: #f8fafc; }
        .card { border: 1px solid #e2e8f0; border-radius: 14px; }
        .shadow-soft { box-shadow: 0 10px 28px rgba(15, 23, 42, 0.07); }
        .doc-row-active { background: #eef2ff; outline: 2px solid #4f46e5; outline-offset: -1px; }
        /* ✅ 히스토리 영역을 채팅창처럼 고정 높이와 스크롤이 가능한 형태로 만듭니다. */
        #answerHistoryList { max-height: 360px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }        
        /* ✅ 질문 전송 시 사용자에게 생각 중임을 알려주는 레이어 스타일입니다. */
        .thinking-indicator { background: rgba(248, 250, 252, 0.85); border: 1px dashed #6366f1; } 
        .search-highlight { background: #fde68a; padding: 0 2px; border-radius: 4px; }
        .suggestion-list { max-height: 220px; overflow-y: auto; z-index: 1050; }               
    </style>
</head>
<body>
<div class="container py-4">

    <div class="card shadow-soft mb-4">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="h4 mb-1">문서 관리</h1>
                <p class="mb-0 text-muted">문서를 업로드하고 검색하거나 질문을 보낼 수 있습니다.</p>
            </div>
            <div class="text-end">
                <div class="small text-muted">전체 문서 수</div>
                <div class="display-6 fw-bold" th:text="${#numbers.formatInteger(page.totalElements, 1, 'COMMA')}">0</div>
            </div>
        </div>
    </div>

    <div th:if="${alertMessage}" class="alert"
         th:classappend="${'alert-' + (#strings.isEmpty(alertType) ? 'info' : alertType)}"
         role="alert" th:text="${alertMessage}"></div>

    <!-- ✅ 최신 응답과 과거 응답을 모두 보여주는 히스토리 카드입니다. -->
    <div class="card shadow-soft mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h3 class="h6 mb-1">질문/답변 히스토리</h3>
                    <div class="small text-muted">최근 응답을 포함해 이전 대화도 한눈에 확인하세요.</div>
                </div>
                <div class="text-end">
                    <span class="badge text-bg-light">실시간 업데이트</span>
                </div>
            </div>
            <p id="historyEmptyMessage" class="text-muted mb-0">아직 받은 답변이 없습니다. 질문을 보내면 여기에 누적됩니다.</p>
            <div id="answerHistoryList" class="d-flex flex-column gap-3"></div>
        </div>
    </div>
             
    <!-- ✅ 서버에서 전달된 최신 응답을 JS 히스토리에 반영하기 위한 데이터 홀더입니다. -->
    <div id="latestAnswerData" class="d-none"
         th:if="${askResult}"
         th:data-question="${askQuestion}"
         th:data-answer="${askResult.answer}"
         th:data-title="${askResult.title ?: '질문 응답'}"
         th:data-target="${askTarget}"
         th:data-mode="${askMode}"
         th:data-from-cache="${askResult.fromCache}"></div>

    <div class="row g-4">
        <div class="col-lg-8">

            <div class="card shadow-soft mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div>
                            <h2 class="h5 mb-1">질문하기</h2>
                            <small class="text-muted">문서를 선택하지 않으면 전체 문서를 대상으로 질문합니다.</small>
                        </div>
                        <span class="badge text-bg-secondary" id="questionTargetBadge"
                              th:text="${askTarget == null || askTarget == 'ALL' ? '대상: 전체 문서' : '대상: ' + askTarget}">
                            대상: 전체 문서
                        </span>
                    </div>

                    <form id="questionForm" th:action="@{/documents/ask}" method="post"
                          th:data-initial-target="${askTarget == null ? 'ALL' : askTarget}"
                          th:data-initial-mode="${askMode == null ? 'STRICT' : askMode}">

                        <div class="mb-3">
                            <label for="questionInput" class="form-label">질문 내용</label>
                            <textarea id="questionInput" name="question" class="form-control" rows="5" required
                                      placeholder="예) 특정 문서의 주요 변경 사항을 알려줘"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label d-block">답변 모드</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="modeStrict" value="STRICT">
                                <label class="form-check-label" for="modeStrict">엄격</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="modeHybrid" value="HYBRID">
                                <label class="form-check-label" for="modeHybrid">하이브리드</label>
                            </div>
                        </div>

                        <!-- ✅ 질문 전송 시 생각 중임을 알려주는 인디케이터입니다. -->
                        <div id="thinkingIndicator"
                             class="alert thinking-indicator d-none d-flex align-items-center gap-3 py-3">
                            <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                            <div>
                                <div class="fw-semibold mb-0">생각 중이에요...</div>
                                <small class="text-muted">최대 60초 동안 답변을 준비합니다. 잠시만 기다려 주세요.</small>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary"
                                    data-bs-toggle="modal" data-bs-target="#searchModal">문서 선택</button>
                            <button type="button" class="btn btn-outline-secondary" id="resetTargetButton">전체 문서로 전환</button>
                            <button type="submit" class="btn btn-primary ms-auto">질문 보내기</button>
                        </div>
                    </form>
                </div>
            </div>


        </div>

        <div class="col-lg-4">

            <div class="card shadow-soft mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h6 mb-0">최근 문서</h2>
                        <span class="badge text-bg-light"
                              th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm')}">--:--</span>
                    </div>

                    <div th:if="${#lists.isEmpty(documents)}" class="text-muted">등록된 문서가 없습니다.</div>

                    <ul class="list-unstyled mb-0" th:if="${!#lists.isEmpty(documents)}">
                        <li class="mb-3" th:each="doc,iter : ${documents}" th:if="${iter.index < 5}">
                            <div class="fw-semibold" th:text="${doc.fileName}"></div>
                            <div class="small text-muted" th:text="${doc.description}"></div>
                            <div class="small text-muted"
                                 th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></div>
                        </li>
                        <li th:if="${documents.size() > 5}" class="small text-muted">
                            추가 문서 <span th:text="${documents.size() - 5}"></span>건이 더 있습니다.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-soft mb-4" th:if="${uploadResult}">
                <div class="card-body">
                    <h2 class="h6 fw-bold mb-3">업로드 완료</h2>
                    <dl class="row mb-0">
                        <dt class="col-4">UUID</dt>
                        <dd class="col-8" th:text="${uploadResult.uuid}"></dd>
                        <dt class="col-4">파일명</dt>
                        <dd class="col-8" th:text="${uploadResult.fileName}"></dd>
                        <dt class="col-4">미리보기</dt>
                        <dd class="col-8">
                            <pre class="mb-0" th:text="${uploadResult.previewText}"></pre>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card shadow-soft">
                <div class="card-body d-grid gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">문서 업로드</button>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#searchModal">문서 검색 및 선택</button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- 업로드 모달 -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="uploadModalLabel">문서 업로드</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">파일</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">설명</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="파일 설명을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="uploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="uploadedBy" name="uploadedBy" value="system">
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">업로드</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 검색 모달 -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true"
     th:data-open-search-modal="${searchTriggered}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="searchModalLabel">문서 검색</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">

                <form class="row g-3 mb-4" method="get" th:action="@{/documents}">
                    <div class="col-md-3 position-relative">
                        <label for="searchFileName" class="form-label">파일명</label>
                        <input type="text" class="form-control" id="searchFileName" name="fileName"
                               th:value="${searchParams.fileName}">
                        <div id="fileNameSuggestions"
                             class="list-group position-absolute w-100 shadow-sm suggestion-list d-none"></div>                               
                    </div>
                    <div class="col-md-3">
                        <label for="searchUploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="searchUploadedBy" name="uploadedBy"
                               th:value="${searchParams.uploadedBy}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchFrom" class="form-label">업로드 시작일</label>
                        <input type="date" class="form-control" id="searchFrom" name="uploadedFrom"
                               th:value="${searchParams.uploadedFrom}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchTo" class="form-label">업로드 종료일</label>
                        <input type="date" class="form-control" id="searchTo" name="uploadedTo"
                               th:value="${searchParams.uploadedTo}">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-secondary">검색</button>
                        <a class="btn btn-outline-secondary" th:href="@{/documents}">초기화</a>
                    </div>
                </form>

                <div class="table-responsive mb-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>UUID</th>
                            <th>파일명</th>
                            <th>업로더</th>
                            <th>업로드 일시</th>
                            <th class="text-end">크기(bytes)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(documents)}">
                            <td colspan="5" class="text-center text-muted">조회된 문서가 없습니다.</td>
                        </tr>

                        <tr th:each="doc : ${documents}"
                            th:attr="data-doc-uuid=${doc.uuid},
                                     data-doc-name=${doc.fileName},
                                     data-doc-desc=${doc.description},
                                     data-doc-uploader=${doc.uploadedBy},
                                     data-doc-uploaded=${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')},
                                     data-doc-size=${#numbers.formatInteger(doc.size, 1, 'COMMA')}">
                            <td class="small text-break" th:text="${doc.uuid}"></td>
                            <td>
                                <div class="fw-semibold doc-file-name" th:text="${doc.fileName}"></div>
                                <div class="small text-muted doc-description" th:text="${doc.description}"></div>
                            </td>
                            <td th:text="${doc.uploadedBy}"></td>
                            <td th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td class="text-end" th:text="${#numbers.formatInteger(doc.size, 1, 'COMMA')}"></td>
                        </tr>

                        </tbody>
                    </table>
                </div>

                <div class="border rounded p-3 mb-4" id="documentDetailPanel"
                     th:attr="data-download-base=@{/api/documents/download/},
                              data-delete-base=@{/documents/}">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h6 mb-0">선택한 문서</h2>
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                id="clearSelectionButton">선택 해제</button>
                    </div>

                    <p class="text-muted mb-0" id="detailPlaceholder">
                        표에서 문서를 선택하면 상세 정보와 작업 버튼이 표시됩니다.
                    </p>

                    <div id="detailContent" class="d-none">
                        <dl class="row mb-3">
                            <dt class="col-sm-3">파일명</dt>
                            <dd class="col-sm-9" id="detailName"></dd>
                            <dt class="col-sm-3">UUID</dt>
                            <dd class="col-sm-9" id="detailUuid"></dd>
                            <dt class="col-sm-3">업로더</dt>
                            <dd class="col-sm-9" id="detailUploader"></dd>
                            <dt class="col-sm-3">업로드 일시</dt>
                            <dd class="col-sm-9" id="detailUploaded"></dd>
                            <dt class="col-sm-3">설명</dt>
                            <dd class="col-sm-9" id="detailDesc"></dd>
                            <dt class="col-sm-3">크기</dt>
                            <dd class="col-sm-9" id="detailSize"></dd>
                        </dl>

                        <div class="d-flex flex-wrap gap-2">
                            <a id="downloadLink" class="btn btn-sm btn-outline-secondary disabled"
                               href="#" target="_blank" aria-disabled="true">다운로드</a>

                            <form id="deleteForm" method="post"
                                  class="d-none"
                                  onsubmit="return confirm('문서를 삭제하시겠습니까?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                            </form>

                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    id="previewButton" disabled>미리보기</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    id="summaryButton" disabled>요약 보기</button>

                            <button type="button" class="btn btn-sm btn-primary"
                                    id="applySelectionButton" disabled>이 문서에 질문</button>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
                    <div class="text-muted small">
                        <span th:text="${page.page + 1}"></span> /
                        <span th:text="${page.totalPages == 0 ? 1 : page.totalPages}"></span>
                        페이지
                    </div>

                    <nav>
                        <ul class="pagination mb-0">

                            <li class="page-item" th:classappend="${page.first} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page - 1}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                    이전
                                </a>
                            </li>

                            <li class="page-item" th:each="num : ${pageNumbers}"
                                th:classappend="${num == page.page} ? ' active'">
                                <a class="page-link"
                                   th:text="${num + 1}"
                                   th:href="@{/documents(page=${num}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                </a>
                            </li>

                            <li class="page-item" th:classappend="${page.last} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page + 1}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                    다음
                                </a>
                            </li>

                        </ul>
                    </nav>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- 문서 미리보기 모달 -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="previewModalLabel">문서 미리보기</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div class="ratio ratio-16x9 bg-light border rounded">
                    <iframe id="previewFrame" title="PDF Preview" class="w-100 h-100 border-0"></iframe>
                </div>
                <p class="small text-muted mt-2 mb-0">
                    PDF가 아닌 문서는 브라우저 미리보기가 지원되지 않을 수 있습니다.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 문서 요약 모달 -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="summaryModalLabel">문서 요약</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div id="summaryLoading" class="d-flex align-items-center gap-2 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                    <span>요약을 생성하고 있습니다...</span>
                </div>
                <div id="summaryError" class="alert alert-danger d-none mt-3"></div>
                <pre id="summaryContent" class="mb-0 d-none"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    var selectedDocument = null;

    // ✅ 질문 대상 배지를 최신 상태로 유지합니다.
    function updateQuestionAction() {
        var form = document.getElementById('questionForm');
        if (!form) return;

        if (selectedDocument && selectedDocument.uuid) {
            form.action = '/documents/' + selectedDocument.uuid + '/ask';
            document.getElementById('questionTargetBadge').textContent =
                '대상: ' + selectedDocument.uuid;
        } else {
            form.action = '/documents/ask';
            document.getElementById('questionTargetBadge').textContent =
                '대상: 전체 문서';
        }
    }

     // ✅ 서버에서 전달된 모드를 다시 선택해 사용자가 선택 값을 유지합니다.
    function applyInitialMode() {
        var form = document.getElementById('questionForm');
        if (!form) return;

        var mode = form.dataset.initialMode || 'STRICT';
        var target = mode === 'HYBRID'
            ? document.getElementById('modeHybrid')
            : document.getElementById('modeStrict');

        if (target) target.checked = true;
    }

    function escapeRegExp(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightMatches(keyword) {
        if (!keyword) return;

        var escaped = escapeRegExp(keyword);
        var regex = new RegExp('(' + escaped + ')', 'gi');
        var targets = document.querySelectorAll('.doc-file-name, .doc-description');

        targets.forEach(function (node) {
            var raw = node.textContent || '';
            if (!raw) return;
            node.innerHTML = raw.replace(regex, '<mark class="search-highlight">$1</mark>');
        });
    }

    function debounce(fn, wait) {
        var timeout;
        return function () {
            var context = this;
            var args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                fn.apply(context, args);
            }, wait);
        };
    }

    function setupFileNameSuggestions() {
        var input = document.getElementById('searchFileName');
        var list = document.getElementById('fileNameSuggestions');
        if (!input || !list) return;

        function hideSuggestions() {
            list.classList.add('d-none');
            list.innerHTML = '';
        }

        function renderSuggestions(items) {
            list.innerHTML = '';
            if (!items || items.length === 0) {
                hideSuggestions();
                return;
            }

            items.forEach(function (item) {
                var option = document.createElement('button');
                option.type = 'button';
                option.className = 'list-group-item list-group-item-action';
                option.innerHTML =
                    '<div class="fw-semibold">' + (item.fileName || '') + '</div>' +
                    (item.description ? '<div class="small text-muted">' + item.description + '</div>' : '');
                option.addEventListener('click', function () {
                    input.value = item.fileName || '';
                    hideSuggestions();
                    input.focus();
                });
                list.appendChild(option);
            });
            list.classList.remove('d-none');
        }

        var fetchSuggestions = debounce(function () {
            var keyword = input.value.trim();
            if (keyword.length < 2) {
                hideSuggestions();
                return;
            }

            fetch('/api/documents/suggest?keyword=' + encodeURIComponent(keyword) + '&limit=6')
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    if (!data || !data.success) {
                        hideSuggestions();
                        return;
                    }
                    renderSuggestions(data.data || []);
                })
                .catch(function () {
                    hideSuggestions();
                });
        }, 200);

        input.addEventListener('input', fetchSuggestions);
        input.addEventListener('blur', function () {
            setTimeout(hideSuggestions, 150);
        });
        document.addEventListener('click', function (event) {
            if (!list.contains(event.target) && event.target !== input) {
                hideSuggestions();
            }
        });
    }

    function openPreviewModal() {
        if (!selectedDocument || !selectedDocument.uuid) return;
        var frame = document.getElementById('previewFrame');
        if (frame) {
            frame.src = '/api/documents/download/' + selectedDocument.uuid;
        }
        var modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();
    }

    function openSummaryModal() {
        if (!selectedDocument || !selectedDocument.uuid) return;

        var loadingEl = document.getElementById('summaryLoading');
        var contentEl = document.getElementById('summaryContent');
        var errorEl = document.getElementById('summaryError');

        loadingEl.classList.remove('d-none');
        contentEl.classList.add('d-none');
        errorEl.classList.add('d-none');
        contentEl.textContent = '';
        errorEl.textContent = '';

        var modal = new bootstrap.Modal(document.getElementById('summaryModal'));
        modal.show();

        fetch('/api/documents/' + selectedDocument.uuid + '/summary')
            .then(function (response) { return response.json(); })
            .then(function (data) {
                loadingEl.classList.add('d-none');
                if (!data || !data.success) {
                    errorEl.textContent = (data && data.message) ? data.message : '요약 생성에 실패했습니다.';
                    errorEl.classList.remove('d-none');
                    return;
                }
                contentEl.textContent = data.data && data.data.answer ? data.data.answer : '';
                contentEl.classList.remove('d-none');
            })
            .catch(function () {
                loadingEl.classList.add('d-none');
                errorEl.textContent = '요약 요청 중 오류가 발생했습니다.';
                errorEl.classList.remove('d-none');
            });
    }

    // ✅ 검색 테이블 행을 클릭했을 때 상세 정보를 패널과 버튼에 반영합니다.
    function bindRowSelection() {
        var rows = Array.from(document.querySelectorAll('[data-doc-uuid]'));

        var detailPlaceholder = document.getElementById('detailPlaceholder');
        var detailContent = document.getElementById('detailContent');

        var nameEl = document.getElementById('detailName');
        var uuidEl = document.getElementById('detailUuid');
        var uploaderEl = document.getElementById('detailUploader');
        var uploadedEl = document.getElementById('detailUploaded');
        var descEl = document.getElementById('detailDesc');
        var sizeEl = document.getElementById('detailSize');

        var downloadLink = document.getElementById('downloadLink');
        var deleteForm = document.getElementById('deleteForm');
        var applyButton = document.getElementById('applySelectionButton');
        var previewButton = document.getElementById('previewButton');
        var summaryButton = document.getElementById('summaryButton');        

        var panel = document.getElementById('documentDetailPanel');
        var downloadBase = panel ? panel.dataset.downloadBase : '';
        var deleteBase = panel ? panel.dataset.deleteBase : '';

        rows.forEach(function (row) {
            row.addEventListener('click', function () {

                rows.forEach(function (r) { r.classList.remove('doc-row-active'); });
                row.classList.add('doc-row-active');

                selectedDocument = {
                    uuid: row.dataset.docUuid,
                    name: row.dataset.docName,
                    uploader: row.dataset.docUploader,
                    uploaded: row.dataset.docUploaded,
                    desc: row.dataset.docDesc,
                    size: row.dataset.docSize
                };

                detailPlaceholder.classList.add('d-none');
                detailContent.classList.remove('d-none');

                nameEl.textContent = selectedDocument.name || '';
                uuidEl.textContent = selectedDocument.uuid || '';
                uploaderEl.textContent = selectedDocument.uploader || '';
                uploadedEl.textContent = selectedDocument.uploaded || '';
                descEl.textContent = selectedDocument.desc || '';
                sizeEl.textContent = selectedDocument.size ? selectedDocument.size + ' bytes' : '';

                if (downloadBase && selectedDocument.uuid) {
                    downloadLink.href = downloadBase + selectedDocument.uuid;
                    downloadLink.classList.remove('disabled');
                }

                if (deleteBase && selectedDocument.uuid) {
                    deleteForm.action = deleteBase + selectedDocument.uuid + '/delete';
                    deleteForm.classList.remove('d-none');
                }

                applyButton.disabled = false;
                if (previewButton) previewButton.disabled = false;
                if (summaryButton) summaryButton.disabled = false;                
            });
        });
    }

    // ✅ 선택된 문서를 초기화해 전체 문서 대상으로 전환합니다.    
    function clearSelection() {
        selectedDocument = null;

        var rows = document.querySelectorAll('[data-doc-uuid]');
        rows.forEach(r => r.classList.remove('doc-row-active'));

        var detailPlaceholder = document.getElementById('detailPlaceholder');
        var detailContent = document.getElementById('detailContent');

        detailPlaceholder.classList.remove('d-none');
        detailContent.classList.add('d-none');

        var applyButton = document.getElementById('applySelectionButton');
        if (applyButton) applyButton.disabled = true;

        var previewButton = document.getElementById('previewButton');
        if (previewButton) previewButton.disabled = true;

        var summaryButton = document.getElementById('summaryButton');
        if (summaryButton) summaryButton.disabled = true;        

        var downloadLink = document.getElementById('downloadLink');
        downloadLink.href = '#';
        downloadLink.classList.add('disabled');

        var deleteForm = document.getElementById('deleteForm');
        deleteForm.action = '';
        deleteForm.classList.add('d-none');

        updateQuestionAction();
    }

    // ✅ 히스토리를 로컬 스토리지에서 불러옵니다.
    function loadHistory() {
        try {
            var stored = localStorage.getItem('oneaskAnswerHistory');
            if (!stored) return [];

            var parsed = JSON.parse(stored);

            // 새로운 구조({ items, order })와 기존 구조(배열)를 모두 지원합니다.
            var items = Array.isArray(parsed)
                ? parsed
                : (Array.isArray(parsed.items) ? parsed.items : []);

            // 기존에는 최신 순으로 저장되었으므로, 최신 항목이 아래로 내려가도록 한 번만 역순 변환합니다.
            if (items.length >= 2) {
                var firstTime = Date.parse(items[0].answeredAt);
                var lastTime = Date.parse(items[items.length - 1].answeredAt);
                if (!isNaN(firstTime) && !isNaN(lastTime) && firstTime > lastTime) {
                    items = items.slice().reverse();
                }
            }

            return items;
        } catch (e) {
            return [];
        }
    }

    // ✅ 히스토리를 로컬 스토리지에 저장합니다.
    function saveHistory(list) {
        localStorage.setItem('oneaskAnswerHistory', JSON.stringify({ items: list, order: 'ASC' }));
    }

    // ✅ 히스토리를 화면에 그려 사용자에게 이전 답변을 보여줍니다.
    function renderHistory(list) {
        var container = document.getElementById('answerHistoryList');
        var emptyMessage = document.getElementById('historyEmptyMessage');

        if (!container || !emptyMessage) return;

        container.innerHTML = '';

        if (!list || list.length === 0) {
            emptyMessage.classList.remove('d-none');
            return;
        }

        emptyMessage.classList.add('d-none');

        list.forEach(function (item) {
            var card = document.createElement('div');
            card.className = 'border rounded p-3 bg-white';

            var header = document.createElement('div');
            header.className = 'd-flex justify-content-between align-items-start mb-2';

            var titleWrap = document.createElement('div');
            var title = document.createElement('div');
            title.className = 'fw-semibold';
            title.textContent = item.title || '질문 응답';

            var meta = document.createElement('div');
            meta.className = 'small text-muted';
            meta.textContent = (item.fromCache ? '캐시 응답 · ' : '실시간 응답 · ') + (item.mode || 'STRICT');

            titleWrap.appendChild(title);
            titleWrap.appendChild(meta);

            var badge = document.createElement('span');
            badge.className = 'badge text-bg-info';
            badge.textContent = item.target === 'ALL' || !item.target
                ? '전체 문서'
                : '문서 UUID: ' + item.target;

            header.appendChild(titleWrap);
            header.appendChild(badge);

            var questionBlock = document.createElement('div');
            questionBlock.className = 'mb-2';
            var questionLabel = document.createElement('div');
            questionLabel.className = 'fw-semibold small text-muted';
            questionLabel.textContent = '나의 질문';
            var questionBody = document.createElement('div');
            questionBody.className = 'border rounded px-3 py-2 bg-light';
            questionBody.textContent = item.question || '';
            questionBlock.appendChild(questionLabel);
            questionBlock.appendChild(questionBody);

            var answerBlock = document.createElement('div');
            var answerLabel = document.createElement('div');
            answerLabel.className = 'fw-semibold small text-muted';
            answerLabel.textContent = '응답';
            var answerBody = document.createElement('pre');
            answerBody.className = 'mb-0';
            answerBody.textContent = item.answer || '';
            answerBlock.appendChild(answerLabel);
            answerBlock.appendChild(answerBody);

            var timeRow = document.createElement('div');
            timeRow.className = 'small text-muted mt-2';
            timeRow.textContent = '응답 시간: ' + (item.answeredAt || '방금');

            card.appendChild(header);
            card.appendChild(questionBlock);
            card.appendChild(answerBlock);
            card.appendChild(timeRow);

            container.appendChild(card);
        });
        // 최신 항목이 항상 하단에 보이도록 스크롤을 고정합니다.
        container.scrollTop = container.scrollHeight;        
    }

    // ✅ 서버 응답을 로컬 스토리지 히스토리에 누적합니다.
    function mergeLatestAnswer() {
        var latestEl = document.getElementById('latestAnswerData');
        if (!latestEl) return;

        var list = loadHistory();
        list.push({
            question: latestEl.dataset.question || '',
            answer: latestEl.dataset.answer || '',
            title: latestEl.dataset.title || '질문 응답',
            target: latestEl.dataset.target || 'ALL',
            mode: latestEl.dataset.mode || 'STRICT',
            fromCache: latestEl.dataset.fromCache === 'true',
            answeredAt: new Date().toLocaleString()
        });

        // 최대 10개까지만 유지해 화면이 과도하게 길어지지 않게 합니다.
        while (list.length > 10) {
            list.shift();
        }

        saveHistory(list);
    }

    // ✅ 질문 전송 시 60초 동안 생각 중임을 알리는 인디케이터를 표시합니다.
    function bindThinkingIndicator() {
        var form = document.getElementById('questionForm');
        var indicator = document.getElementById('thinkingIndicator');
        var submitButton = form ? form.querySelector('button[type="submit"]') : null;

        if (!form || !indicator) return;

        form.addEventListener('submit', function () {
            indicator.classList.remove('d-none');
            if (submitButton) submitButton.disabled = true;

            var messageEl = indicator.querySelector('small');
            var elapsed = 0;

            var timer = setInterval(function () {
                elapsed += 1;
                if (!messageEl) return;

                if (elapsed < 60) {
                    messageEl.textContent = '최대 60초 동안 답변을 준비합니다. 경과: ' + elapsed + '초';
                } else {
                    messageEl.textContent = '조금만 더 기다려 주세요. 현재도 생각 중입니다.';
                }
            }, 1000);

            // 페이지가 이동하면 타이머가 자동으로 정리되므로 별도 종료 로직은 필요 없습니다.
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('questionForm');
        var initialTarget = form ? form.dataset.initialTarget : 'ALL';

        if (initialTarget && initialTarget !== 'ALL') {
            selectedDocument = { uuid: initialTarget };
        }

        updateQuestionAction();
        applyInitialMode();
        bindRowSelection();
        bindThinkingIndicator();
        setupFileNameSuggestions();

        var keywordInput = document.getElementById('searchFileName');
        if (keywordInput && keywordInput.value) {
            highlightMatches(keywordInput.value.trim());
        }

        mergeLatestAnswer();
        renderHistory(loadHistory());
        
        var applyButton = document.getElementById('applySelectionButton');
        applyButton.addEventListener('click', function () {
            updateQuestionAction();
            var modal = bootstrap.Modal.getInstance(
                document.getElementById('searchModal')
            );
            modal.hide();
        });

        var resetButton = document.getElementById('resetTargetButton');
        resetButton.addEventListener('click', function () {
            clearSelection();
        });

        var clearButton = document.getElementById('clearSelectionButton');
        clearButton.addEventListener('click', function () {
            clearSelection();
        });

        var previewButton = document.getElementById('previewButton');
        if (previewButton) {
            previewButton.addEventListener('click', function () {
                openPreviewModal();
            });
        }

        var summaryButton = document.getElementById('summaryButton');
        if (summaryButton) {
            summaryButton.addEventListener('click', function () {
                openSummaryModal();
            });
        }
                
        var searchModalEl = document.getElementById('searchModal');
        if (searchModalEl.dataset.openSearchModal === 'true') {
            new bootstrap.Modal(searchModalEl).show();
        }
    });
</script>

</body>
</html>
