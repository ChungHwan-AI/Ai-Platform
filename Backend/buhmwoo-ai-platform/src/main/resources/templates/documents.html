<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>문서 관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body { background: #f8fafc; }
        .card { border: 1px solid #e2e8f0; border-radius: 14px; }
        .shadow-soft { box-shadow: 0 10px 28px rgba(15, 23, 42, 0.07); }
        .doc-row-active { background: #eef2ff; outline: 2px solid #4f46e5; outline-offset: -1px; }
    </style>
</head>
<body>
<div class="container py-4">

    <div class="card shadow-soft mb-4">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="h4 mb-1">문서 관리</h1>
                <p class="mb-0 text-muted">문서를 업로드하고 검색하거나 질문을 보낼 수 있습니다.</p>
            </div>
            <div class="text-end">
                <div class="small text-muted">전체 문서 수</div>
                <div class="display-6 fw-bold" th:text="${#numbers.formatInteger(page.totalElements, 1, 'COMMA')}">0</div>
            </div>
        </div>
    </div>

    <div th:if="${alertMessage}" class="alert"
         th:classappend="${'alert-' + (#strings.isEmpty(alertType) ? 'info' : alertType)}"
         role="alert" th:text="${alertMessage}"></div>

    <!-- 최근 질문과 응답을 알림 영역 바로 아래에 배치해 사용자가 즉시 확인할 수 있도록 합니다. -->
    <div class="card shadow-soft mb-4" th:if="${askResult}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h3 class="h6 mb-1" th:text="${askResult.title ?: '질문 응답'}">질문 응답</h3>
                    <div class="small text-muted" th:text="${askResult.fromCache} ? '캐시 응답' : '실시간 응답'"></div>
                </div>
                <div class="text-end">
                    <span class="badge text-bg-info"
                          th:text="${askTarget == 'ALL' ? '전체 문서' : '문서 UUID: ' + askTarget}"></span>
                </div>
            </div>

            <div class="mb-2">
                <div class="fw-semibold small text-muted">나의 질문</div>
                <div class="border rounded px-3 py-2 bg-light" th:text="${askQuestion}"></div>
            </div>

            <div class="mb-3">
                <div class="fw-semibold small text-muted">응답</div>
                <pre class="mb-0" th:text="${askResult.answer}"></pre>
            </div>

            <div th:if="${askResult.sources}" class="border-top pt-3">
                <h4 class="h6 fw-semibold mb-2">참고 문서</h4>
                <ul class="mb-0 ps-3">
                    <li th:each="source : ${askResult.sources}" class="mb-2">
                        <div class="fw-semibold">
                            <span th:text="${source.reference}"></span>
                            <span class="text-muted"
                                  th:if="${source.source}" th:text="${' · ' + source.source}"></span>
                        </div>
                        <div class="small text-muted" th:if="${source.page != null}" th:text="${'페이지: ' + source.page}"></div>
                        <div class="small" th:text="${source.preview}"></div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
             
    <div class="row g-4">
        <div class="col-lg-8">

            <div class="card shadow-soft mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div>
                            <h2 class="h5 mb-1">질문하기</h2>
                            <small class="text-muted">문서를 선택하지 않으면 전체 문서를 대상으로 질문합니다.</small>
                        </div>
                        <span class="badge text-bg-secondary" id="questionTargetBadge"
                              th:text="${askTarget == null || askTarget == 'ALL' ? '대상: 전체 문서' : '대상: ' + askTarget}">
                            대상: 전체 문서
                        </span>
                    </div>

                    <form id="questionForm" th:action="@{/documents/ask}" method="post"
                          th:data-initial-target="${askTarget == null ? 'ALL' : askTarget}"
                          th:data-initial-mode="${askMode == null ? 'STRICT' : askMode}">

                        <div class="mb-3">
                            <label for="questionInput" class="form-label">질문 내용</label>
                            <textarea id="questionInput" name="question" class="form-control" rows="5" required
                                      placeholder="예) 특정 문서의 주요 변경 사항을 알려줘"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label d-block">답변 모드</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="modeStrict" value="STRICT">
                                <label class="form-check-label" for="modeStrict">엄격</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="modeHybrid" value="HYBRID">
                                <label class="form-check-label" for="modeHybrid">하이브리드</label>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary"
                                    data-bs-toggle="modal" data-bs-target="#searchModal">문서 선택</button>
                            <button type="button" class="btn btn-outline-secondary" id="resetTargetButton">전체 문서로 전환</button>
                            <button type="submit" class="btn btn-primary ms-auto">질문 보내기</button>
                        </div>
                    </form>
                </div>
            </div>


        </div>

        <div class="col-lg-4">

            <div class="card shadow-soft mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h6 mb-0">최근 문서</h2>
                        <span class="badge text-bg-light"
                              th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm')}">--:--</span>
                    </div>

                    <div th:if="${#lists.isEmpty(documents)}" class="text-muted">등록된 문서가 없습니다.</div>

                    <ul class="list-unstyled mb-0" th:if="${!#lists.isEmpty(documents)}">
                        <li class="mb-3" th:each="doc,iter : ${documents}" th:if="${iter.index < 5}">
                            <div class="fw-semibold" th:text="${doc.fileName}"></div>
                            <div class="small text-muted" th:text="${doc.description}"></div>
                            <div class="small text-muted"
                                 th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></div>
                        </li>
                        <li th:if="${documents.size() > 5}" class="small text-muted">
                            추가 문서 <span th:text="${documents.size() - 5}"></span>건이 더 있습니다.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-soft mb-4" th:if="${uploadResult}">
                <div class="card-body">
                    <h2 class="h6 fw-bold mb-3">업로드 완료</h2>
                    <dl class="row mb-0">
                        <dt class="col-4">UUID</dt>
                        <dd class="col-8" th:text="${uploadResult.uuid}"></dd>
                        <dt class="col-4">파일명</dt>
                        <dd class="col-8" th:text="${uploadResult.fileName}"></dd>
                        <dt class="col-4">미리보기</dt>
                        <dd class="col-8">
                            <pre class="mb-0" th:text="${uploadResult.previewText}"></pre>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card shadow-soft">
                <div class="card-body d-grid gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">문서 업로드</button>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#searchModal">문서 검색 및 선택</button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- 업로드 모달 -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="uploadModalLabel">문서 업로드</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">파일</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">설명</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="파일 설명을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label for="uploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="uploadedBy" name="uploadedBy" value="system">
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">업로드</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 검색 모달 -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true"
     th:data-open-search-modal="${searchTriggered}">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="searchModalLabel">문서 검색</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">

                <form class="row g-3 mb-4" method="get" th:action="@{/documents}">
                    <div class="col-md-3">
                        <label for="searchFileName" class="form-label">파일명</label>
                        <input type="text" class="form-control" id="searchFileName" name="fileName"
                               th:value="${searchParams.fileName}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchUploadedBy" class="form-label">업로더</label>
                        <input type="text" class="form-control" id="searchUploadedBy" name="uploadedBy"
                               th:value="${searchParams.uploadedBy}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchFrom" class="form-label">업로드 시작일</label>
                        <input type="date" class="form-control" id="searchFrom" name="uploadedFrom"
                               th:value="${searchParams.uploadedFrom}">
                    </div>
                    <div class="col-md-3">
                        <label for="searchTo" class="form-label">업로드 종료일</label>
                        <input type="date" class="form-control" id="searchTo" name="uploadedTo"
                               th:value="${searchParams.uploadedTo}">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-secondary">검색</button>
                        <a class="btn btn-outline-secondary" th:href="@{/documents}">초기화</a>
                    </div>
                </form>

                <div class="table-responsive mb-3">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>UUID</th>
                            <th>파일명</th>
                            <th>업로더</th>
                            <th>업로드 일시</th>
                            <th class="text-end">크기(bytes)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(documents)}">
                            <td colspan="5" class="text-center text-muted">조회된 문서가 없습니다.</td>
                        </tr>

                        <tr th:each="doc : ${documents}"
                            th:attr="data-doc-uuid=${doc.uuid},
                                     data-doc-name=${doc.fileName},
                                     data-doc-desc=${doc.description},
                                     data-doc-uploader=${doc.uploadedBy},
                                     data-doc-uploaded=${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')},
                                     data-doc-size=${#numbers.formatInteger(doc.size, 1, 'COMMA')}">
                            <td class="small text-break" th:text="${doc.uuid}"></td>
                            <td>
                                <div class="fw-semibold" th:text="${doc.fileName}"></div>
                                <div class="small text-muted" th:text="${doc.description}"></div>
                            </td>
                            <td th:text="${doc.uploadedBy}"></td>
                            <td th:text="${#temporals.format(doc.uploadedAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td class="text-end" th:text="${#numbers.formatInteger(doc.size, 1, 'COMMA')}"></td>
                        </tr>

                        </tbody>
                    </table>
                </div>

                <div class="border rounded p-3 mb-4" id="documentDetailPanel"
                     th:attr="data-download-base=@{/api/documents/download/},
                              data-delete-base=@{/documents/}">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h2 class="h6 mb-0">선택한 문서</h2>
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                id="clearSelectionButton">선택 해제</button>
                    </div>

                    <p class="text-muted mb-0" id="detailPlaceholder">
                        표에서 문서를 선택하면 상세 정보와 작업 버튼이 표시됩니다.
                    </p>

                    <div id="detailContent" class="d-none">
                        <dl class="row mb-3">
                            <dt class="col-sm-3">파일명</dt>
                            <dd class="col-sm-9" id="detailName"></dd>
                            <dt class="col-sm-3">UUID</dt>
                            <dd class="col-sm-9" id="detailUuid"></dd>
                            <dt class="col-sm-3">업로더</dt>
                            <dd class="col-sm-9" id="detailUploader"></dd>
                            <dt class="col-sm-3">업로드 일시</dt>
                            <dd class="col-sm-9" id="detailUploaded"></dd>
                            <dt class="col-sm-3">설명</dt>
                            <dd class="col-sm-9" id="detailDesc"></dd>
                            <dt class="col-sm-3">크기</dt>
                            <dd class="col-sm-9" id="detailSize"></dd>
                        </dl>

                        <div class="d-flex flex-wrap gap-2">
                            <a id="downloadLink" class="btn btn-sm btn-outline-secondary disabled"
                               href="#" target="_blank" aria-disabled="true">다운로드</a>

                            <form id="deleteForm" method="post"
                                  class="d-none"
                                  onsubmit="return confirm('문서를 삭제하시겠습니까?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
                            </form>

                            <button type="button" class="btn btn-sm btn-primary"
                                    id="applySelectionButton" disabled>이 문서에 질문</button>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
                    <div class="text-muted small">
                        <span th:text="${page.page + 1}"></span> /
                        <span th:text="${page.totalPages == 0 ? 1 : page.totalPages}"></span>
                        페이지
                    </div>

                    <nav>
                        <ul class="pagination mb-0">

                            <li class="page-item" th:classappend="${page.first} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page - 1}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                    이전
                                </a>
                            </li>

                            <li class="page-item" th:each="num : ${pageNumbers}"
                                th:classappend="${num == page.page} ? ' active'">
                                <a class="page-link"
                                   th:text="${num + 1}"
                                   th:href="@{/documents(page=${num}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                </a>
                            </li>

                            <li class="page-item" th:classappend="${page.last} ? ' disabled'">
                                <a class="page-link"
                                   th:href="@{/documents(page=${page.page + 1}, size=${page.size},
                                             fileName=${searchParams.fileName},
                                             uploadedBy=${searchParams.uploadedBy},
                                             uploadedFrom=${searchParams.uploadedFrom},
                                             uploadedTo=${searchParams.uploadedTo})}">
                                    다음
                                </a>
                            </li>

                        </ul>
                    </nav>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    var selectedDocument = null;

    function updateQuestionAction() {
        var form = document.getElementById('questionForm');
        if (!form) return;

        if (selectedDocument && selectedDocument.uuid) {
            form.action = '/documents/' + selectedDocument.uuid + '/ask';
            document.getElementById('questionTargetBadge').textContent =
                '대상: ' + selectedDocument.uuid;
        } else {
            form.action = '/documents/ask';
            document.getElementById('questionTargetBadge').textContent =
                '대상: 전체 문서';
        }
    }

    function applyInitialMode() {
        var form = document.getElementById('questionForm');
        if (!form) return;

        var mode = form.dataset.initialMode || 'STRICT';
        var target = mode === 'HYBRID'
            ? document.getElementById('modeHybrid')
            : document.getElementById('modeStrict');

        if (target) target.checked = true;
    }

    function bindRowSelection() {
        var rows = Array.from(document.querySelectorAll('[data-doc-uuid]'));

        var detailPlaceholder = document.getElementById('detailPlaceholder');
        var detailContent = document.getElementById('detailContent');

        var nameEl = document.getElementById('detailName');
        var uuidEl = document.getElementById('detailUuid');
        var uploaderEl = document.getElementById('detailUploader');
        var uploadedEl = document.getElementById('detailUploaded');
        var descEl = document.getElementById('detailDesc');
        var sizeEl = document.getElementById('detailSize');

        var downloadLink = document.getElementById('downloadLink');
        var deleteForm = document.getElementById('deleteForm');
        var applyButton = document.getElementById('applySelectionButton');

        var panel = document.getElementById('documentDetailPanel');
        var downloadBase = panel ? panel.dataset.downloadBase : '';
        var deleteBase = panel ? panel.dataset.deleteBase : '';

        rows.forEach(function (row) {
            row.addEventListener('click', function () {

                rows.forEach(function (r) { r.classList.remove('doc-row-active'); });
                row.classList.add('doc-row-active');

                selectedDocument = {
                    uuid: row.dataset.docUuid,
                    name: row.dataset.docName,
                    uploader: row.dataset.docUploader,
                    uploaded: row.dataset.docUploaded,
                    desc: row.dataset.docDesc,
                    size: row.dataset.docSize
                };

                detailPlaceholder.classList.add('d-none');
                detailContent.classList.remove('d-none');

                nameEl.textContent = selectedDocument.name || '';
                uuidEl.textContent = selectedDocument.uuid || '';
                uploaderEl.textContent = selectedDocument.uploader || '';
                uploadedEl.textContent = selectedDocument.uploaded || '';
                descEl.textContent = selectedDocument.desc || '';
                sizeEl.textContent = selectedDocument.size ? selectedDocument.size + ' bytes' : '';

                if (downloadBase && selectedDocument.uuid) {
                    downloadLink.href = downloadBase + selectedDocument.uuid;
                    downloadLink.classList.remove('disabled');
                }

                if (deleteBase && selectedDocument.uuid) {
                    deleteForm.action = deleteBase + selectedDocument.uuid + '/delete';
                    deleteForm.classList.remove('d-none');
                }

                applyButton.disabled = false;
            });
        });
    }

    function clearSelection() {
        selectedDocument = null;

        var rows = document.querySelectorAll('[data-doc-uuid]');
        rows.forEach(r => r.classList.remove('doc-row-active'));

        var detailPlaceholder = document.getElementById('detailPlaceholder');
        var detailContent = document.getElementById('detailContent');

        detailPlaceholder.classList.remove('d-none');
        detailContent.classList.add('d-none');

        var applyButton = document.getElementById('applySelectionButton');
        if (applyButton) applyButton.disabled = true;

        var downloadLink = document.getElementById('downloadLink');
        downloadLink.href = '#';
        downloadLink.classList.add('disabled');

        var deleteForm = document.getElementById('deleteForm');
        deleteForm.action = '';
        deleteForm.classList.add('d-none');

        updateQuestionAction();
    }

    document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('questionForm');
        var initialTarget = form ? form.dataset.initialTarget : 'ALL';

        if (initialTarget && initialTarget !== 'ALL') {
            selectedDocument = { uuid: initialTarget };
        }

        updateQuestionAction();
        applyInitialMode();
        bindRowSelection();

        var applyButton = document.getElementById('applySelectionButton');
        applyButton.addEventListener('click', function () {
            updateQuestionAction();
            var modal = bootstrap.Modal.getInstance(
                document.getElementById('searchModal')
            );
            modal.hide();
        });

        var resetButton = document.getElementById('resetTargetButton');
        resetButton.addEventListener('click', function () {
            clearSelection();
        });

        var clearButton = document.getElementById('clearSelectionButton');
        clearButton.addEventListener('click', function () {
            clearSelection();
        });

        var searchModalEl = document.getElementById('searchModal');
        if (searchModalEl.dataset.openSearchModal === 'true') {
            new bootstrap.Modal(searchModalEl).show();
        }
    });
</script>

</body>
</html>
